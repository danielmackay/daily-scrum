@page "/daily-scrum"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@using System.Net
@inject NavigationManager NavigationManager

<PageTitle>Daily Scrum</PageTitle>

<h1>Daily Scrum</h1>

<p>Let's make the daily scrum great again.</p>

<EditForm Model="@Model" OnValidSubmit="@HandleValidSubmit" FormName="generate">
    <DataAnnotationsValidator/>
    <ValidationSummary/>

    <div class="form-group" style="margin-bottom: 20px">
        <label for="name">Name:</label>
        <InputText id="name" class="form-control" @bind-Value="Model.Name"/>
    </div>

    <div class="form-group" style="margin-bottom: 20px">
        <label for="clientDays">Days until client booking:</label>
        <InputText id="clientDays" class="form-control" @bind-Value="Model.ClientDays"/>
    </div>

    <div class="form-group" style="margin-bottom: 20px">
        <label for="lastWorkingDay">Last Working Day:</label>
        <InputDate id="lastWorkingDay" class="form-control" @bind-Value="Model.LastWorkingDay"/>
    </div>

    <div class="form-group" style="margin-bottom: 20px">
        <label for="accessToken">Access Token:</label>
        <InputText id="accessToken" class="form-control" @bind-Value="Model.AccessToken"/>
        <span>Acquire token from <a href="https://developer.microsoft.com/en-us/graph/graph-explorer" target="_blank">Microsoft Graph Explorer</a></span>
    </div>

    <button type="submit" class="btn btn-primary">Create Email</button>
</EditForm>

@code {
    [SupplyParameterFromForm] private DailyScrumInputModel Model { get; set; } = new();

    private void HandleValidSubmit()
    {
        // Handle the form submission here.

        // NOTE: This throws an exception, but apparently it's expected 🤦
        // https://github.com/dotnet/aspnetcore/issues/50478
        var accessToken = WebUtility.UrlEncode(Model.AccessToken);
        var url = $"/daily-scrum/preview?name={Model.Name}&clientDays={Model.ClientDays}&lastWorkingDay={Model.LastWorkingDay.ToString("O")}&accessToken={accessToken}";
        //var encodedUrl = WebUtility.UrlEncode(url);
        NavigationManager.NavigateTo(url, true);
    }

    public class DailyScrumInputModel
    {
        [Required]
        public string Name { get; set; } = String.Empty;

        [Required]
        public string AccessToken { get; set; } = String.Empty;

        // NOTE: THis needs to be a string due to the following bug with nullable fields
        // https://github.com/dotnet/aspnetcore/issues/52195
        public string ClientDays { get; set; } = String.Empty;

        public DateOnly LastWorkingDay { get; set; } = DateOnly.FromDateTime(DateTime.Now.AddDays(-1));
    }
}
